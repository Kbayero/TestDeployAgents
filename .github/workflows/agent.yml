name: Agent Build
on:
  push:
    tags: [ 'v*' ]
    branches: [ "main", "qa", "rc" ]
    paths: 
      - 'agent/**'
      - 'version.yml'

jobs:
  build:
    name: Build
    runs-on: YORJANDER
    steps:
      - name: Determine Build Environment
        id: set-env
        run: |
          if ("${{ github.event_name }}" -eq 'push' -and "${{ github.ref_name }}" -eq 'main') {
            Write-Host "Agent Deployment to DEV"
            $env:DEPLOY_ENV = 'dev'
          } elif ("${{ github.event_name }}" -eq 'push' -and "${{ github.ref_name }}" -eq 'qa' ) {
            Write-Host "Agent Deployment to QA"
            $env:DEPLOY_ENV = 'qa'
          } elif ("${{ github.event_name }}" -eq 'push' -and "${{ github.ref_name }}" -eq 'rc' ) {
            Write-Host "Agent Deployment to RC"
            $env:DEPLOY_ENV = 'rc'
          } elif ("${{ github.event_name }}" -eq 'push' -and "${{ github.ref }}" -match '^refs/tags/v') {
            Write-Host "Agent Deployment to RELEASE"
            $env:DEPLOY_ENV = 'release'
          }
      
      - name: Build for Linux
        working-directory: ./agent
        env:
          GOOS: linux
          GOARCH: amd64
        run: |
          go build -o utmstack_agent_service -v ./agent
          go build -o utmstack_agent_installer -v ./installer
          go build -o utmstack_redline_service -v ./redline
          go build -o utmstack_updater_service -v ./updater

      - name: Build and sign for Windows
        working-directory: ./agent
        env:
          GOOS: windows
          GOARCH: amd64
          SIGN_KEY: ${{ secrets.SIGN_KEY }}
          SIGN_CERT: ${{ env.SIGN_CERT }}
          SIGN_CONTAINER: ${{ secrets.SIGN_CONTAINER }}
        run: |
          go build -o utmstack_agent_service.exe -v ./agent
          go build -o utmstack_agent_installer.exe -v ./installer
          go build -o utmstack_redline_service.exe -v ./redline
          go build -o utmstack_updater_service.exe -v ./updater
           